var i="Mozilla/5.0";import{createHash as v}from"crypto";var w=class{async init(t,e){let s={"x-csrftoken":"a","x-requested-with":"XMLHttpRequest",Cookie:"scratchcsrftoken=a;scratchlanguage=en;",referer:"https://scratch.mit.edu","User-Agent":i},o=await fetch("https://scratch.mit.edu/login/",{method:"POST",body:JSON.stringify({username:t,password:e}),headers:s});if(!o.ok)throw new Error("Login failed.");let r=o.headers.get("set-cookie");if(!r)throw Error("Something went wrong");let n=/scratchcsrftoken=(.*?);/gm.exec(r)[1],h=/"(.*)"/gm.exec(r)[1],c="scratchcsrftoken="+n+";scratchlanguage=en;scratchsessionsid="+h+";",d=await(await fetch("https://scratch.mit.edu/session",{method:"GET",headers:{Cookie:c,"User-Agent":i,Referer:"https://scratch.mit.edu/","Cache-Control":"max-age=0, no-cache","X-Requested-With":"XMLHttpRequest",Pragma:"no-cache",Accept:"*/*","Accept-Encoding":"gzip, deflate, br"}})).json();this.auth={username:t,csrfToken:n,token:h,cookieSet:c,sessionJSON:d}}async uploadToAssets(t,e){if(!this.auth)throw Error("You must be logged in to use this");let s=v("md5").update(t).digest("hex");if(!(await fetch(`https://assets.scratch.mit.edu/${s}.${e}`,{method:"POST",body:t,headers:{Cookie:this.auth.cookieSet,"User-Agent":i,Referer:"https://scratch.mit.edu/","Cache-Control":"no-cache",Pragma:"no-cache",Accept:"*/*","Accept-Encoding":"gzip, deflate, br"}})).ok)throw new Error("Upload failed");return`https://assets.scratch.mit.edu/${s}.${e}`}async searchProjects(t,e=16,s=0,o="popular"){let r=await fetch(`https://api.scratch.mit.edu/search/projects?limit=${e}&offset=${s}&language=en&mode=${o}&q=${t}`);if(!r.ok)throw new Error("Request failed");return await r.json()}async getMessages(t=40,e=0){if(!this.auth)throw Error("You must be logged in to use this");let s=await fetch(`https://api.scratch.mit.edu/users/${this.auth.username}/messages?limit=${t}&offset=${e}`,{headers:{Origin:"https://scratch.mit.edu",Referer:"https://scratch.mit.edu/","X-Token":this.auth.sessionJSON.user.token}});if(!s.ok)throw Error(`Request failed with status ${s.status}`);return await s.json()}async logout(){if(!this.auth)throw Error("You must be logged in to use this");let t=await fetch("https://scratch.mit.edu/accounts/logout/",{method:"POST",body:`csrfmiddlewaretoken=${this.auth.csrfToken}`,headers:{Cookie:this.auth.cookieSet,"User-Agent":i,accept:"application/json",Referer:"https://scratch.mit.edu/",Origin:"https://scratch.mit.edu","Content-Type":"application/x-www-form-urlencoded",Accept:"*/*","Accept-Encoding":"gzip, deflate, br"}});if(!t.ok)throw new Error(`Error in logging out. ${t.status}`);this.auth=void 0}},X=w;import{parse as _}from"node-html-parser";var b=class{constructor(t,e){this.user=e,this.session=t}async getStatus(){return _(await this.getUserHTML()).querySelector(".group").innerHTML.trim()}async follow(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/site-api/users/followers/${this.user}/add/?usernames=${this.session.auth.sessionJSON.user.username}`,{method:"PUT",headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,referer:`https://scratch.mit.edu/users/${this.user}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw Error(`Request failed with status ${t.status}`)}async unfollow(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/site-api/users/followers/${this.user}/remove/?usernames=${this.session.auth.sessionJSON.user.username}`,{method:"PUT",headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,referer:`https://scratch.mit.edu/users/${this.user}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw Error(`Request failed with status ${t.status}`)}async comment(t,e,s){if(!this.session?.auth)throw Error("You need to be logged in");if(!(await fetch(`https://scratch.mit.edu/site-api/comments/user/${this.user}/add/`,{method:"POST",body:JSON.stringify({content:t,parent_id:e||"",commentee_id:s||""}),headers:{"X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/users/${this.user}`,"User-Agent":i}})).ok)throw new Error("Error adding comment.")}async deleteComment(t){if(!this.session?.auth)throw Error("You need to be logged in");if(!(await fetch(`https://scratch.mit.edu/site-api/comments/user/${this.user}/del/`,{method:"POST",body:JSON.stringify({id:t.toString()}),headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,referer:`https://scratch.mit.edu/users/${this.user}`,"User-Agent":i}})).ok)throw new Error("Error deleting comment.")}async getUserHTML(){let t=await fetch(`https://scratch.mit.edu/users/${this.user}`);if(!t.ok)throw new Error("Cannot find user.");return await t.text()}async getUserAPI(){let t=await fetch(`https://api.scratch.mit.edu/users/${this.user}`);if(!t.ok)throw new Error("Cannot find user.");return await t.json()}async getMessageCount(){let t=await fetch(`https://api.scratch.mit.edu/users/${this.user}/messages/count`);if(!t.ok)throw Error(`Request failed with status ${t.status}`);return Number((await t.json()).count)}async getComments(t=1){let e=await fetch(`https://scratch.mit.edu/site-api/comments/user/${this.user}/?page=${t}`);if(!e.ok){if(t==1)throw new Error("! Error in fetching comments");return[]}let s=await e.text(),r=_(s).querySelectorAll(".top-level-reply"),n=[];for(let h in r){let c=r[h];if(typeof c=="function")break;let u=c.querySelector(".comment").id,d=c.querySelector(".comment").getElementsByTagName("a")[0].getAttribute("data-comment-user"),l=c.querySelector(".comment").querySelector(".info").querySelector(".content").innerHTML.trim(),g=[],j=c.querySelector(".replies").querySelectorAll(".reply");for(let P in j){let m=j[P];if(m.tagName==="A"||typeof m=="function"||typeof m=="number")continue;let O=m.querySelector(".comment").id,U=m.querySelector(".comment").getElementsByTagName("a")[0].getAttribute("data-comment-user"),N=m.querySelector(".comment").querySelector(".info").querySelector(".content").textContent.trim().replace(/\n+/gm,"").replace(/\s+/gm," ");g.push({id:O,username:U,content:N,apiID:O.substring(9)})}n.push({id:u,username:d,content:l,apiID:u.substring(9),replies:g})}if(n.length==0)throw new Error("No comments found.");return n}async toggleComments(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/site-api/comments/user/${this.user}/toggle-comments/`,{method:"POST",headers:{"X-CSRFToken":this.session.auth.csrfToken,Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/users/${this.user}/`}});if(!t.ok)throw Error(`Request failed with status ${t.status}`)}};var k=class{constructor(t,e){this.id=e,this.session=t}async getAPIData(){return await(await fetch(`https://api.scratch.mit.edu/studios/${this.id}/`,{headers:{"User-Agent":i}})).json()}async follow(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/site-api/users/bookmarkers/${this.id}/add/?usernames=${this.session.auth.sessionJSON.user.username}`,{method:"PUT",headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,referer:`https://scratch.mit.edu/studios/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw Error(`Request failed with status ${t.status}`)}async unfollow(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/site-api/users/bookmarkers/${this.id}/remove/?usernames=${this.session.auth.sessionJSON.user.username}`,{method:"PUT",headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,referer:`https://scratch.mit.edu/studios/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw Error(`Request failed with status ${t.status}`)}async setTitle(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://scratch.mit.edu/site-api/galleries/all/${this.id}/`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.auth.csrfToken,Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/studios/${this.id}`},body:JSON.stringify({title:t})});if(!e.ok)throw new Error(`Could not set title - ${e.statusText}`)}async setDescription(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://scratch.mit.edu/site-api/galleries/all/${this.id}/`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.auth.csrfToken,Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/studios/${this.id}`},body:JSON.stringify({description:t})});if(!e.ok)throw new Error(`Could not set description - ${e.statusText}`)}async inviteCurator(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://scratch.mit.edu/site-api/users/curators-in/${this.id}/invite_curator/?usernames=${t}`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.auth.csrfToken,Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/studios/${this.id}/curators`}});if(!e.ok)throw new Error(`Could not invite curator - ${e.statusText}`)}async removeCurator(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://scratch.mit.edu/site-api/users/curators-in/${this.id}/remove/?usernames=${t}`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.auth.csrfToken,Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/studios/${this.id}/curators`}});if(!e.ok)throw new Error(`Could not remove curator - ${e.statusText}`)}async acceptInvite(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/site-api/users/curators-in/${this.id}/add/?usernames=${this.session.auth.sessionJSON.user.username}`,{method:"PUT",headers:{"User-Agent":i,"X-CSRFToken":this.session.auth.csrfToken,Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/studios/${this.id}/curators`}});if(!t.ok)throw Error(`Could not join studio -- did you get an invite? ${t.statusText}`)}async getUserData(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://api.scratch.mit.edu/studios/${this.id}/users/${this.session.auth.sessionJSON.user.username}`,{headers:{"User-Agent":i,"X-Token":this.session.auth.sessionJSON.user.token}});if(!t.ok)throw new Error(`Could not get data - ${t.statusText}`);return await t.json()}async addProject(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://api.scratch.mit.edu/studios/${this.id}/project/${t}`,{method:"POST",headers:{"User-Agent":i,"X-Token":this.session.auth.sessionJSON.user.token}});if(!e.ok)throw new Error(`Could not add project - ${e.statusText}`)}async removeProject(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://api.scratch.mit.edu/studios/${this.id}/project/${t}`,{method:"DELETE",headers:{"User-Agent":i,"X-Token":this.session.auth.sessionJSON.user.token}});if(!e.ok)throw new Error(`Could not remove project - ${e.statusText}`)}async comment(t,e,s){if(!this.session?.auth)throw Error("You need to be logged in");let o=await fetch(`https://api.scratch.mit.edu/proxy/comments/studio/${this.id}`,{method:"POST",body:JSON.stringify({content:t,commentee_id:s||"",parent_id:e||""}),headers:{"X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,Cookie:this.session.auth.cookieSet,Referer:"https://scratch.mit.edu/","Content-Type":"application/json",TE:"trailers","User-Agent":i,Accept:"application/json","Accept-Language":"en, en;q=0.8",Origin:"https://scratch.mit.edu","Cache-Control":"no-cache",Pragma:"no-cache",Connection:"keep-alive","Accept-Encoding":"gzip, deflate, br"}});if(!o.ok)throw Error(`Request failed with status ${o.status}`);return Number((await o.json()).id)}async toggleComments(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/site-api/comments/gallery/${this.id}/toggle-comments/`,{method:"POST",headers:{"User-Agent":i,"X-CSRFToken":this.session.auth.csrfToken,Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/studios/${this.id}/comments`}});if(!t.ok)throw Error(`Request failed with status ${t.status}`)}async getCurators(t=24,e=0){let s=await fetch(`https://api.scratch.mit.edu/studios/${this.id}/curators/?limit=${t}&offset=${e}`,{headers:{"User-Agent":i}});if(!s.ok)throw new Error(`Could not get curators - ${s.statusText}`);return await s.json()}async getManagers(t=24,e=0){let s=await fetch(`https://api.scratch.mit.edu/studios/${this.id}/managers/?limit=${t}&offset=${e}`,{headers:{"User-Agent":i}});if(!s.ok)throw new Error(`Could not get managers - ${s.statusText}`);return await s.json()}async getProjects(t=24,e=0){let s=await fetch(`https://api.scratch.mit.edu/studios/${this.id}/projects/?limit=${t}&offset=${e}`,{headers:{"User-Agent":i}});if(!s.ok)throw new Error(`Could not get projects - ${s.statusText}`);return await s.json()}},F=k;var y=class{constructor(t,e){this.id=e,this.session=t}async getAPIData(){let t=await fetch(`https://api.scratch.mit.edu/projects/${this.id}`,{headers:{"User-Agent":i}});if(!t.ok)throw new Error("Cannot find project.");return await t.json()}async getComments(t=0,e=20){let s=await this.getAPIData(),o=await fetch(`https://api.scratch.mit.edu/users/${s.author.username}/projects/${this.id}/comments?offset=${t}&limit=${e}`,{headers:{"User-Agent":i}});if(!o.ok)throw new Error(`Comments returned status ${o.status} - ${o.statusText}`);return await o.json()}async getCommentReplies(t,e=0,s=20){let o=await this.getAPIData(),r=await fetch(`https://api.scratch.mit.edu/users/${o.author.username}/projects/${this.id}/comments/${t}/replies?offset=${e}&limit=${s}`,{headers:{"User-Agent":i}});if(!r.ok)throw new Error(`Comments returned status ${r.status} - ${r.statusText}`);return await r.json()}async comment(t,e,s){if(!this.session?.auth)throw Error("You need to be logged in");let o=await fetch(`https://api.scratch.mit.edu/proxy/comments/project/${this.id}`,{method:"POST",body:JSON.stringify({content:t,commentee_id:s||"",parent_id:e||""}),headers:{"X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,Cookie:this.session.auth.cookieSet,Referer:"https://scratch.mit.edu/","Content-Type":"application/json",TE:"trailers","User-Agent":i,Accept:"application/json","Accept-Language":"en, en;q=0.8",Origin:"https://scratch.mit.edu","Cache-Control":"no-cache",Pragma:"no-cache",Connection:"keep-alive","Accept-Encoding":"gzip, deflate, br"}});if(!o.ok)throw Error(`Request failed with status ${o.status}`);return Number((await o.json()).id)}async setCommentsAllowed(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://api.scratch.mit.edu/projects/${this.id}`,{method:"PUT",body:JSON.stringify({comments_allowed:t}),headers:{"X-Token":this.session.auth.sessionJSON.user.token,"Content-Type":"application/json",Origin:"https://scratch.mit.edu",Referer:"https://scratch.mit.edu/"}});if(!e.ok)throw Error(`Request failed with status ${e.status}`)}async setTitle(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://api.scratch.mit.edu/projects/${this.id}`,{method:"PUT",body:JSON.stringify({title:t}),headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!e.ok)throw new Error(`Error in setting title. ${e.status}`)}async setInstructions(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://api.scratch.mit.edu/projects/${this.id}`,{method:"PUT",body:JSON.stringify({instructions:t}),headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!e.ok)throw new Error(`Error in setting instructions. ${e.status}`)}async setNotesAndCredits(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://api.scratch.mit.edu/projects/${this.id}`,{method:"PUT",body:JSON.stringify({description:t}),headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!e.ok)throw new Error(`Error in setting Notes and Credits. ${e.status}`)}async setThumbnail(t){if(!this.session?.auth)throw Error("You need to be logged in");if(!(await fetch(`https://scratch.mit.edu/internalapi/project/thumbnail/${this.id}/set/`,{method:"POST",body:t,headers:{"X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,Cookie:this.session.auth.cookieSet,"User-Agent":i}})).ok)throw Error("Request not ok")}async unshare(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/site-api/projects/all/${this.id}/`,{method:"PUT",body:JSON.stringify({isPublished:!1}),headers:{"x-csrftoken":this.session.auth.csrfToken,"X-Token":this.session.auth.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,accept:"application/json","Content-Type":"application/json"}});if(!t.ok)throw new Error(`Error in unsharing. ${t.status}`)}async isLoving(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://api.scratch.mit.edu/projects/${this.id}/loves/user/${this.session.auth.sessionJSON.user.username}`,{headers:{"User-Agent":i,Accept:"*/*","Accept-Language":"en, en;q=0.8","X-Token":this.session.auth.sessionJSON.user.token,Pragma:"no-cache","Cache-Control":"no-cache"},referrer:"https://scratch.mit.edu/"});if(!t.ok)throw Error(`Request failed with status ${t.status}`);return(await t.json()).userLove}async isFavoriting(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://api.scratch.mit.edu/projects/${this.id}/favorites/user/${this.session.auth.sessionJSON.user.username}`,{headers:{"User-Agent":i,Accept:"*/*","Accept-Language":"en, en;q=0.8","X-Token":this.session.auth.sessionJSON.user.token,Pragma:"no-cache","Cache-Control":"no-cache"},referrer:"https://scratch.mit.edu/"});if(!t.ok)throw Error(`Request failed with status ${t.status}`);return(await t.json()).userFavorite}async setLoving(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://api.scratch.mit.edu/proxy/projects/${this.id}/loves/user/${this.session.auth.sessionJSON.user.username}`,{method:t?"POST":"DELETE",headers:{"X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,Referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,Accept:"*/*","Content-Length":"0",Origin:"https://scratch.mit.edu","Cache-Control":"max-age=0, no-cache",Pragma:"no-cache","Accept-Encoding":"gzip, deflate, br"}});if(!e.ok)throw Error(`Request failed with status ${e.status}`)}async setFavoriting(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://api.scratch.mit.edu/proxy/projects/${this.id}/favorites/user/${this.session.auth.sessionJSON.user.username}`,{method:t?"POST":"DELETE",headers:{"X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,Referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,Accept:"*/*","Content-Length":"0",Origin:"https://scratch.mit.edu","Cache-Control":"max-age=0, no-cache",Pragma:"no-cache","Accept-Encoding":"gzip, deflate, br"}});if(!e.ok)throw Error(`Request failed with status ${e.status}`)}async share(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://api.scratch.mit.edu/proxy/projects/${this.id}/share/`,{method:"PUT",headers:{"X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest",Cookie:this.session.auth.cookieSet,Referer:`https://scratch.mit.edu/projects/${this.id}/`,"User-Agent":i,Accept:"application/json","Content-Type":"application/json","Content-Length":"0",Origin:"https://scratch.mit.edu","Cache-Control":"max-age=0, no-cache",Pragma:"no-cache","Accept-Encoding":"gzip, deflate, br"}});if(!t.ok)throw new Error(`Error in sharing. ${t.status}`)}},J=y;import{WebSocket as L}from"ws";import Y from"events";var S=class extends Y.EventEmitter{constructor(e,s){super();this.open=!1;this.queue=[];this.variables=new Map;this.disconnected=!1;this.id=s,this.session=e,this.connect()}connect(){if(!this.session?.auth)throw Error("You need to be logged in");this.open=!1,this.connection=new L("wss://clouddata.scratch.mit.edu",{headers:{Cookie:this.session.auth.cookieSet,Origin:"https://scratch.mit.edu"}}),this.connection.on("message",e=>{if(e)for(let s of e.toString().split(`
`)){let o=JSON.parse(s||'{"method": "err"}');o.method=="set"&&(this.emit("set",{name:o.name,value:o.value.toString()}),this.variables.set(o.name,o.value.toString()))}}),this.connection.on("open",()=>{if(!this.session?.auth)throw Error("You need to be logged in");this.open=!0,this.send({method:"handshake",user:this.session.auth.sessionJSON.user.username,project_id:this.id.toString()}),this.emit("connect",null);for(let e of this.queue)this.send(e)}),this.connection.on("error",e=>{this.emit("error",e)}),this.connection.on("close",()=>{this.disconnected||(this.emit("reconnect",null),this.connect())})}send(e){this.emit("internal-send",e),this.connection.send(`${JSON.stringify(e)}
`)}setVariable(e,s){if(!this.session?.auth)throw Error("You need to be logged in");let o=e.startsWith("\u2601 ")?e.substring(2):e;if(this.variables.set(`\u2601 ${o}`,s.toString()),!this.open){this.queue.push({user:this.session.auth.sessionJSON.user.username,method:"set",name:`\u2601 ${o}`,value:s.toString(),project_id:this.id});return}this.send({user:this.session.auth.sessionJSON.user.username,method:"set",name:`\u2601 ${o}`,value:s.toString(),project_id:this.id})}getVariable(e){let s=e.startsWith("\u2601 ")?e.substring(2):e;return this.variables.get(`\u2601 ${s}`)}close(){this.emit("close",null),this.disconnected=!0,this.connection.close()}},M=S;import D from"events";var p=class{constructor(){this.charset="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ`~1234567890! @#$%^&*()_-.\";:'?><,/".split("")}encode(t){let e="";for(let s=0;s<t.length;s++)e+=this.charset.findIndex(o=>o===t[s])+10;return e+"00"}*decode(t){let e="";for(let s=1;s<t.length;s+=2){let o=Number(t[s-1]+t[s])-10;o<0?(yield e,e=""):e+=this.charset[o]}}};var T=new p,$=class extends D.EventEmitter{constructor(e){super();this.onRequest=Symbol("onRequest");this.connection=e,this.connection.on("set",s=>{if(String(s.name).includes("FROM_USER")){let o=T.decode(s.value),r=o.next().value,n=o.next().value;if(!r||!n)return;this.emit(this.onRequest,r,n),this.emit(r,n)}})}send(e,s){let o=T.encode(e)+T.encode(s);this.connection.setVariable("FROM_SERVER_SEND",o)}},I=$;import{parse as x}from"node-html-parser";import{Readable as z}from"stream";import{FormData as B}from"formdata-node";import{FormDataEncoder as W}from"form-data-encoder";import{parse as H}from"node-html-parser";var E=class{constructor(t,e,s){this.id=e,this.session=t,s&&(this.data=s)}async setData(){let t=await fetch(`https://scratch.mit.edu/discuss/m/post/${this.id}`);if(!t.ok)throw Error(`Request failed with status ${t.status}`);let s=H(await t.text()).getElementById(`post-${this.id}`);s&&(this.data={parsableContent:s.querySelector(".post-content"),content:s.querySelector(".post-content").text,author:s.getElementsByTagName("header")[0].getElementsByTagName("h1")[0].text,time:new Date(s.querySelector("time").getAttribute("datetime"))})}async getSource(){let t=await fetch(`https://scratch.mit.edu/discuss/post/${this.id}/source/`);if(!t.ok)throw Error(`Request failed with status ${t.status}`);return await t.text()}async edit(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://scratch.mit.edu/discuss/post/${this.id}/edit/`,{headers:{Cookie:this.session.auth.cookieSet,"User-Agent":i,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/post/${this.id}/edit/`},method:"POST",body:`csrfmiddlewaretoken=${this.session.auth.csrfToken}&body=${encodeURIComponent(t)}`});if(!e.ok)throw new Error(`Error editing post ${this.id} - ${e.statusText}`)}},C=E;function f(a){let t=[];return new Promise((e,s)=>{a.on("data",o=>t.push(Buffer.from(o))),a.on("error",o=>s(o)),a.on("end",()=>e(Buffer.concat(t).toString("utf8")))})}var q=class{constructor(t,e,s){this.id=e,this.session=t,s&&(this.data=s)}async setData(){let t=await fetch(`https://scratch.mit.edu/discuss/m/topic/${this.id}`);if(!t.ok)throw Error(`Request failed with status ${t.status}`);let e=x(await t.text()),s=Number(e.querySelector(".pagination > li:last-child span")?.text)||1,o=0;if(s===1)o=e.querySelectorAll("article").length-1;else{let r=await fetch(`https://scratch.mit.edu/discuss/m/topic/${this.id}/?page=${s}`);if(!r.ok)throw Error(`Request failed with status ${t.status}`);let n=x(await r.text());o=(s-1)*20+n.querySelectorAll("article").length-1}this.data={title:e.querySelector("nav > h1").childNodes.filter(r=>r.nodeType===3).map(r=>r.text).join("").trim(),replyCount:o}}async getPosts(t=1){let e=[],s=await fetch(`https://scratch.mit.edu/discuss/m/topic/${this.id}/?page=${t}`,{headers:{"User-Agent":i}});if(!s.ok)throw new Error(`Error fetching posts for topic ${this.id} - ${s.statusText}`);return x(await s.text()).querySelector(".content").getElementsByTagName("article").forEach(n=>{let h=n.getAttribute("id").split("-")[1],c=n.querySelector(".post-content").innerHTML,u=n.querySelector(".post-content"),d=new Date(n.querySelector("time").getAttribute("datetime")),l=new C(this.session,Number(h),{content:c,time:d,parsableContent:u,author:n.getElementsByTagName("header")[0].getElementsByTagName("h1")[0].text});e.push(l)}),e}async reply(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=new B;e.append("csrfmiddlewaretoken",this.session.auth.csrfToken),e.append("body",t),e.append("AddPostForm","");let s=new W(e),o=await fetch(`https://scratch.mit.edu/discuss/topic/${this.id}/`,{method:"POST",body:await f(z.from(s.encode())),headers:{Cookie:this.session.auth.cookieSet,"User-Agent":i,Accept:"*/*","X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":s.contentType,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/topic/${this.id}/`}});if(!o.ok)throw Error(`Request failed with status ${o.status}`)}async follow(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/discuss/subscription/topic/${this.id}/add/`,{method:"POST",headers:{Cookie:this.session.auth.cookieSet,"User-Agent":i,Accept:"*/*","X-CSRFToken":this.session.auth.csrfToken,"Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/topic/${this.id}/`}});if(!t.ok)throw new Error(`Error following topic ${this.id} - ${t.statusText}`)}async unfollow(){if(!this.session?.auth)throw Error("You need to be logged in");let t=await fetch(`https://scratch.mit.edu/discuss/subscription/topic/${this.id}/delete/`,{method:"POST",headers:{Cookie:this.session.auth.cookieSet,"User-Agent":i,Accept:"*/*","X-CSRFToken":this.session.auth.csrfToken,"Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/topic/${this.id}/`}});if(!t.ok)throw new Error(`Error unfollowing topic ${this.id} - ${t.statusText}`)}},A=q;import{parse as V}from"node-html-parser";import{Readable as G}from"stream";import{FormData as K}from"formdata-node";import{FormDataEncoder as Q}from"form-data-encoder";var R=class{constructor(t,e){this.id=e,this.session=t}async getTopics(t=1){let e=[],s=await fetch(`https://scratch.mit.edu/discuss/m/${this.id}/?page=${t}`,{headers:{"User-Agent":i}});if(!s.ok)throw new Error(`Error fetching topics for forum ${this.id} - ${s.statusText}`);return V(await s.text()).querySelector(".topic.list").getElementsByTagName("li").forEach(h=>{let c=h.getElementsByTagName("a")[0].getAttribute("href").split("/").splice(1)[3],u=h.querySelector("strong").text,d=Number(h.querySelector(".item span").innerText.split(" ")[0]),l=h.classList.contains("sticky"),g=new A(this.session,Number(c),{title:u,replyCount:d,sticky:l});e.push(g)}),e}async createTopic(t,e){if(!this.session?.auth)throw Error("You need to be logged in");if(!this.id)throw Error("You need to add a forum id");let s=new K;s.append("csrfmiddlewaretoken",this.session.auth.csrfToken),s.append("name",t),s.append("body",e),s.append("subscribe","on"),s.append("AddPostForm","");let o=new Q(s),r=await fetch(`https://scratch.mit.edu/discuss/${this.id}/topic/add/`,{method:"POST",body:await f(G.from(o.encode())),headers:{Cookie:this.session.auth.cookieSet,"User-Agent":i,Accept:"*/*","X-CSRFToken":this.session.auth.csrfToken,"X-Token":this.session.auth.sessionJSON.user.token,"x-requested-with":"XMLHttpRequest","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":o.contentType,Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/${this.id}/topic/add`}});if(!r.ok)throw Error(`Request failed with status ${r.status}`)}async setSignature(t){if(!this.session?.auth)throw Error("You need to be logged in");let e=await fetch(`https://scratch.mit.edu/discuss/settings/${this.session.auth.sessionJSON.user.username}/`,{headers:{Cookie:this.session.auth.cookieSet,"User-Agent":i,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache","Content-Type":"application/x-www-form-urlencoded",Origin:"https://scratch.mit.edu",Referer:`https://scratch.mit.edu/discuss/settings/${this.session.auth.sessionJSON.user.username}/`},method:"POST",body:`csrfmiddlewaretoken=${this.session.auth.csrfToken}&signature=${encodeURIComponent(t)}&update=`});if(!e.ok)throw new Error(`Error editing signature - ${e.statusText}`)}},Z=R;export{M as CloudConnection,p as CloudSerialiser,Z as Forum,I as PacketCloud,C as Post,b as Profile,J as Project,X as ScratchSession,F as Studio,A as Topic};
